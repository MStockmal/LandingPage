<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-P">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission 1895 - Lockport Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; /* Prevent scrolling of the page */
        }
        body {
            font-family: 'Merriweather', serif;
            background-color: #3a2f2f;
            color: #e0dcd1;
            margin: 0;
            padding: 0;
        }

        /* Full-screen map */
        #map {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 100vw;
            z-index: 100;
        }

        /* Initially hidden elements */
        .hidden-on-load {
            display: none;
        }

        /* Header Styling */
        header {
            background-color: rgba(24, 10, 10, 0.9); /* Darkened opacity */
            padding: 0.5rem; /* Adjusted padding */
            text-align: center;
            border-bottom: 4px solid #8c0000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px; /* Fixed height for the header */
            position: relative;
            z-index: 101;
        }

        header img.header-logo {
            max-width: 100%;
            max-height: 100%; /* Allow logo to fill header height */
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .title-font { /* For other titles if needed */
            font-family: 'IM Fell English SC', serif;
        }

        /* Map controls styling */
        .map-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(44, 30, 30, 0.85);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            text-align: center;
            z-index: 102; /* Ensure controls are on top of the map */
        }
        .map-controls label {
            color: #f5e8c8;
            margin-right: 10px;
            font-family: 'IM Fell English SC', serif;
            font-size: 1.1em;
        }
        .map-controls input[type="range"] {
            width: 200px;
            vertical-align: middle;
            cursor: pointer;
        }


        .leaflet-popup-content-wrapper {
            background: #fdf5e6;
            color: #4a3b31;
            border-radius: 5px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        }
        .leaflet-popup-content h3 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 1.3em;
            font-family: 'IM Fell English SC', serif;
            color: #5a3d2b;
        }
        .leaflet-popup-content p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        .leaflet-popup-tip {
            background: #fdf5e6;
        }
        .popup-button {
            background-color: #6a0dad;
            color: #fff;
            padding: 8px 12px;
            border: 1px solid #40006b;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Merriweather', serif;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            display: block;
            width: calc(100% - 10px);
            margin: 10px 5px 5px 5px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .popup-button:hover {
            background-color: #800080;
            border-color: #500050;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            padding-top: 20px;
        }
        .modal-content {
            background-color: #f5e8c8;
            margin: 5% auto;
            padding: 25px;
            border: 5px solid #8c0000;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 0 25px rgba(0,0,0,0.8);
            position: relative;
            font-family: 'Merriweather', serif;
            color: #4a3b31;
        }
        .modal-content h2, .modal-content h3 {
             font-family: 'IM Fell English SC', serif;
             color: #5a3d2b;
        }
        .close-button {
            color: #5a3d2b;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 35px;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: #8c0000;
            text-decoration: none;
            cursor: pointer;
        }
        #modalCharacterCard {
            width: 100%;
            max-width: 250px;
            height: auto;
            object-fit: contain;
            margin-top: 15px;
            margin-bottom: 15px;
            border: 3px solid #8c0000;
            border-radius: 8px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        #modalImage {
            width: 100%;
            max-width: 400px;
            object-fit: contain;
            margin-top: 15px;
            border: 2px solid #8B4513;
            border-radius: 5px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .image-toggle-buttons button {
            background-color: #8B4513;
            color: white;
            padding: 10px 15px;
            margin: 10px 5px 0 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Merriweather', serif;
            transition: background-color 0.3s ease;
        }
        .image-toggle-buttons button:hover {
            background-color: #A0522D;
        }
        .intro-text {
            background-color: rgba(245, 232, 200, 0.9);
            padding: 20px;
            margin: 30px auto;
            border-radius: 8px;
            border: 3px dashed #8c0000;
            text-align: justify;
            color: #4a3b31;
            max-width: 900px;
            position: relative;
            z-index: 101;
        }
         .intro-text h2 {
            font-family: 'IM Fell English SC', serif;
            color: #5a3d2b;
         }

        .custom-marker-icon {
            background-color: #8B4513;
            border: 2px solid #D2B48C;
            border-radius: 50%;
            width: 20px !important;
            height: 20px !important;
            text-align: center;
            line-height: 16px;
            color: white;
            font-weight: bold;
            font-size: 10px;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .image-animation-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 2 / 3;
            margin-top: 15px;
            border: 2px solid #8B4513;
            border-radius: 5px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            overflow: hidden;
        }
        .animated-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        .animated-image.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <header class="hidden-on-load">
        <img src="https://i.postimg.cc/YCfDn7rz/M1895withlightning.png" alt="Mission 1895 Lockport Logo" class="header-logo">
    </header>

    <div class="map-controls"> <label for="opacitySlider">Fantasy Map Opacity:</label>
        <input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="1.0">
    </div>

    <div id="map"></div>

    <div class="intro-text mt-6 mb-6 hidden-on-load">
        <h2 class="text-3xl mb-3 title-font">A Message from The Sentinel...</h2>
        <p>In the early 1830’s, dreamy eyed settlers from the east had arrived on the unbroken prairie of what would soon be known as Lockport. Because of a forty-foot drop in elevation along the Des Plaines River, men with vision saw that they could harness nature and supply hydro-electric power for all their needs. Terrain thus fated Lockport to be the headquarters of the great I&M Canal – an inland waterway linking New York to New Orleans... But by 1895, the once promising and hopeful city of Lockport had fallen into darkness... The evil that undermines men’s desires to build towers to heaven by their own hand had beginnings much further back...</p>
        <p class="mt-2">Use this Chrono-Map to navigate the streets of 1895 Lockport, uncover the secrets of its denizens, and aid in a mission of utmost importance!</p>
    </div>

    <div id="detailsModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle" class="text-3xl mb-3"></h2>
        <h3 class="text-xl mb-1"><strong>Character:</strong> <span id="modalCharacter"></span></h3>
        <p><strong>Address:</strong> <span id="modalAddress"></span></p> <p><strong>Operating Hours:</strong> <span id="modalHours"></span></p> <img id="modalCharacterCard" src="" alt="Character Card" style="display: none;">

        <h3 class="text-xl mt-4 mb-2">Chronovisor Report:</h3>
        <div id="modalDescription" class="text-sm leading-relaxed max-h-60 overflow-y-auto pr-2"></div>
        <div class="image-toggle mt-4 text-center">
          <div id="imageAnimationContainer" class="image-animation-container" style="display: none;">
            <img id="modalImagePresent" src="" alt="Present Day View" class="animated-image">
            <img id="modalImage1895" src="" alt="1895 Steampunk View" class="animated-image">
            <img id="modalImageCharacter" src="" alt="1895 Character View" class="animated-image">
            <img id="modalImageCharacterAnimated" src="" alt="1895 Character Animated View" class="animated-image">
          </div>
          <img id="modalImage" src="" alt="Location Image" style="display: block;">
          <div class="image-toggle-buttons mt-2" style="display: block;">
            <button id="steampunkBtn">View Steampunk Version</button>
            <button id="realBtn">View Real Version</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="locations.js"></script>
    <script>
        // --- MAP INITIALIZATION ---
        const map = L.map('map', {
            zoomControl: false // Disable zoom control to keep the view clean
        }).setView([41.589, -88.0575], 17); // Centered and zoomed on Downtown Lockport

        // Satellite Base Layer (can be removed if you ONLY want the fantasy map)
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        }); //.addTo(map); // Initially commented out to only show fantasy map

        // Fantasy Map Overlay from MapWarper
        const fantasyMapUrl = 'https://mapwarper.net/maps/tile/91451/{z}/{x}/{y}.png';
        const fantasyMapLayer = L.tileLayer(fantasyMapUrl, {
            attribution: 'Fantasy Map Overlay &copy; <a href="https://mapwarper.net/maps/91451" target="_blank">MapWarper</a>',
            opacity: 1.0,
            minZoom: 13,
            maxZoom: 19,
            tms: false
        }).addTo(map);

        fantasyMapLayer.on('tileerror', function(event) {
            console.error('Fantasy map tile failed to load:', event.tile, event.url);
        });

        // Opacity Slider Event Listener
        const opacitySlider = document.getElementById('opacitySlider');
        opacitySlider.addEventListener('input', function (e) {
            const newOpacity = parseFloat(e.target.value);
            fantasyMapLayer.setOpacity(newOpacity);

            // Optional: Show satellite layer if fantasy map is partially transparent
            if (newOpacity < 1.0 && !map.hasLayer(satelliteLayer)) {
                map.addLayer(satelliteLayer);
                satelliteLayer.bringToBack();
            } else if (newOpacity >= 1.0 && map.hasLayer(satelliteLayer)) {
                map.removeLayer(satelliteLayer);
            }
        });


        // --- MODAL GLOBALS ---
        const modal = document.getElementById('detailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalCharacter = document.getElementById('modalCharacter');
        const modalAddress = document.getElementById('modalAddress');
        const modalHours = document.getElementById('modalHours');
        const modalDescription = document.getElementById('modalDescription');
        const modalCharacterCard = document.getElementById('modalCharacterCard');

        const oldModalImage = document.getElementById('modalImage');
        const steampunkBtn = document.getElementById('steampunkBtn');
        const realBtn = document.getElementById('realBtn');
        const oldImageButtonsContainer = document.querySelector('.image-toggle-buttons');

        const animationContainer = document.getElementById('imageAnimationContainer');
        const modalImagePresent = document.getElementById('modalImagePresent');
        const modalImage1895 = document.getElementById('modalImage1895');
        const modalImageCharacter = document.getElementById('modalImageCharacter');
        const modalImageCharacterAnimated = document.getElementById('modalImageCharacterAnimated');


        let currentModalLocation = null;
        let currentImageIndex = 0;
        let animationInterval = null;

        // --- ADD MARKERS TO MAP ---
        locationsData.forEach(location => {
            const customIcon = L.divIcon({
                className: 'custom-marker-icon',
                html: `<span>${location.id}</span>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });

            const marker = L.marker([location.lat, location.lon], { icon: customIcon }).addTo(map);
            const popupContent = `
                <h3 class="title-font">${location.locationName}</h3>
                <p><strong>Character:</strong> ${location.characterName}</p>
                <p>${location.description.substring(0, 100).replace(/\\n/g, ' ')}...</p>
                <button class="popup-button" onclick="showDetails(${location.id})">View Details & Chronovisor</button>
            `;
            marker.bindPopup(popupContent);
        });

        // --- VALIDATION FUNCTION FOR IMAGE URLS ---
        function isValidImageUrl(url) {
            return url && typeof url === 'string' && !url.includes('placehold.co') && url.startsWith('http');
        }

        // --- ANIMATION FUNCTIONS ---
        function startImageAnimation() {
            if (animationInterval) clearInterval(animationInterval);

            if (!currentModalLocation) return;

            const imagesToAnimate = [];

            if (isValidImageUrl(currentModalLocation.imagePresentDayUrl)) {
                imagesToAnimate.push(modalImagePresent);
            }
            if (isValidImageUrl(currentModalLocation.image1895SteampunkUrl)) {
                imagesToAnimate.push(modalImage1895);
            }
            if (isValidImageUrl(currentModalLocation.image1895CharacterUrl)) {
                imagesToAnimate.push(modalImageCharacter);
            }
            if (isValidImageUrl(currentModalLocation.imageCharacterAnimatedUrl)) {
                imagesToAnimate.push(modalImageCharacterAnimated);
            }

            if (imagesToAnimate.length === 0) {
                animationContainer.style.display = 'none';
                return;
            }

            [modalImagePresent, modalImage1895, modalImageCharacter, modalImageCharacterAnimated].forEach(img => {
                if(img) img.classList.remove('active');
            });

            currentImageIndex = 0;
            if (imagesToAnimate.length > 0 && imagesToAnimate[currentImageIndex]) {
                 imagesToAnimate[currentImageIndex].classList.add('active');
            }

            animationInterval = setInterval(() => {
                if (imagesToAnimate.length > 0 && imagesToAnimate[currentImageIndex]) {
                    imagesToAnimate[currentImageIndex].classList.remove('active');
                }
                currentImageIndex = (currentImageIndex + 1) % imagesToAnimate.length;
                if (imagesToAnimate.length > 0 && imagesToAnimate[currentImageIndex]) {
                    imagesToAnimate[currentImageIndex].classList.add('active');
                }
            }, 3000);
        }

        // --- MODAL FUNCTIONS ---
        function showDetails(locationId) {
            currentModalLocation = locationsData.find(loc => loc.id === locationId);
            if (!currentModalLocation) return;

            modalTitle.textContent = currentModalLocation.locationName;
            modalCharacter.textContent = currentModalLocation.characterName;
            modalAddress.textContent = currentModalLocation.address;
            modalHours.textContent = currentModalLocation.hours;
            modalDescription.innerHTML = currentModalLocation.description.replace(/\\n/g, '<br>');

            // Handle Character Card Image Display
            if (isValidImageUrl(currentModalLocation.characterCardUrl)) {
                modalCharacterCard.src = currentModalLocation.characterCardUrl;
                modalCharacterCard.alt = `${currentModalLocation.characterName} Card`;
                modalCharacterCard.style.display = 'block';
                modalCharacterCard.onerror = function() {
                    this.style.display = 'none';
                    console.error(`Character card for ${currentModalLocation.locationName} failed to load: ${this.src}`);
                };
            } else {
                modalCharacterCard.style.display = 'none';
                modalCharacterCard.src = '';
            }

            const useNewAnimation = isValidImageUrl(currentModalLocation.imagePresentDayUrl) &&
                                    isValidImageUrl(currentModalLocation.image1895SteampunkUrl) &&
                                    isValidImageUrl(currentModalLocation.image1895CharacterUrl);

            if (useNewAnimation) {
                animationContainer.style.display = 'block';
                oldModalImage.style.display = 'none';
                oldImageButtonsContainer.style.display = 'none';

                modalImagePresent.src = currentModalLocation.imagePresentDayUrl;
                modalImagePresent.alt = `Present day view of ${currentModalLocation.locationName}`;

                modalImage1895.src = currentModalLocation.image1895SteampunkUrl;
                modalImage1895.alt = `1895 Steampunk view of ${currentModalLocation.locationName}`;

                modalImageCharacter.src = currentModalLocation.image1895CharacterUrl;
                modalImageCharacter.alt = `1895 Character view of ${currentModalLocation.locationName}`;

                if (isValidImageUrl(currentModalLocation.imageCharacterAnimatedUrl)) {
                    modalImageCharacterAnimated.src = currentModalLocation.imageCharacterAnimatedUrl;
                    modalImageCharacterAnimated.alt = `1895 Character animated view of ${currentModalLocation.locationName}`;
                } else {
                    modalImageCharacterAnimated.src = "";
                    modalImageCharacterAnimated.alt = "";
                }

                [modalImagePresent, modalImage1895, modalImageCharacter, modalImageCharacterAnimated].forEach(img => {
                    if(img) {
                        img.onerror = function() {
                            this.src = 'https://placehold.co/400x600/CCCCCC/FFF?text=Image+Not+Found';
                            if(animationInterval) clearInterval(animationInterval);
                            animationInterval = null;
                             console.error(`Slideshow image for ${currentModalLocation.locationName} failed to load: ${this.src}`);
                        };
                    }
                });
                startImageAnimation();
            } else {
                animationContainer.style.display = 'none';
                oldModalImage.style.display = 'block';
                oldImageButtonsContainer.style.display = 'block';
                if (animationInterval) clearInterval(animationInterval);
                animationInterval = null;

                let steampunkSource = currentModalLocation.imageSteampunkUrl || currentModalLocation.image1895SteampunkUrl;
                let realSource = currentModalLocation.imageRealUrl || currentModalLocation.imagePresentDayUrl;

                steampunkSource = isValidImageUrl(steampunkSource) ? steampunkSource : 'https://placehold.co/400x300/CCCCCC/FFF?text=Steampunk+Not+Available';
                realSource = isValidImageUrl(realSource) ? realSource : 'https://placehold.co/400x300/CCCCCC/FFF?text=Real+Not+Available';

                oldModalImage.src = steampunkSource;
                oldModalImage.alt = `Steampunk view of ${currentModalLocation.locationName}`;
                oldModalImage.onerror = function() {
                    this.src = 'https://placehold.co/400x300/CCCCCC/FFF?text=Image+Not+Found';
                    console.error(`Fallback image for ${currentModalLocation.locationName} failed to load: ${this.src}`);
                };

                steampunkBtn.onclick = () => toggleImage('steampunk', steampunkSource, realSource);
                realBtn.onclick = () => toggleImage('real', steampunkSource, realSource);
            }
            modal.style.display = "block";
        }

        function closeModal() {
            modal.style.display = "none";
            if (animationInterval) clearInterval(animationInterval);
            animationInterval = null;
            currentModalLocation = null;
            [modalImagePresent, modalImage1895, modalImageCharacter, modalImageCharacterAnimated, oldModalImage, modalCharacterCard].forEach(img => {
                if(img) {
                    img.src = "";
                    img.onerror = null;
                }
            });
        }

        function toggleImage(type, steampunkSrc, realSrc) {
            if (!currentModalLocation) return;

            let targetSrc = '';
            let altText = '';

            if (type === 'steampunk') {
                targetSrc = steampunkSrc;
                altText = `Steampunk view of ${currentModalLocation.locationName}`;
            } else if (type === 'real') {
                targetSrc = realSrc;
                altText = `Real view of ${currentModalLocation.locationName}`;
            }

            oldModalImage.src = targetSrc.replace(/\\n/g, '');
            oldModalImage.alt = altText;
            oldModalImage.onerror = function() {
                this.src = 'https://placehold.co/400x300/CCCCCC/FFF?text=Image+Not+Found';
                console.error(`Fallback (toggled) image for ${currentModalLocation.locationName} failed to load: ${this.src}`);
            };
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                closeModal();
            }
        });

    </script>
</body>
</html>