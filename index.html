<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-P">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission 1895 - Lockport Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; /* Prevent scrolling of the page */
        }
        body {
            font-family: 'Merriweather', serif;
            background-color: #3a2f2f;
            color: #e0dcd1;
            margin: 0;
            padding: 0;
        }

        /* Full-screen map */
        #map {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 100vw;
            z-index: 100;
        }

        /* Initially hidden elements */
        .hidden-on-load {
            display: none;
        }

        /* Floating Logo */
        #floating-logo {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 250px;
            height: auto;
            z-index: 102;
            filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.7));
        }

        .title-font { /* For other titles if needed */
            font-family: 'IM Fell English SC', serif;
        }

        /* Map controls styling */
        .map-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(44, 30, 30, 0.85);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            text-align: center;
            z-index: 102; /* Ensure controls are on top of the map */
        }
        .map-controls label {
            color: #f5e8c8;
            margin-right: 10px;
            font-family: 'IM Fell English SC', serif;
            font-size: 1.1em;
        }
        .map-controls input[type="range"] {
            width: 200px;
            vertical-align: middle;
            cursor: pointer;
        }


        .leaflet-popup-content-wrapper {
            background: #fdf5e6;
            color: #4a3b31;
            border-radius: 5px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        }
        .leaflet-popup-content h3 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 1.3em;
            font-family: 'IM Fell English SC', serif;
            color: #5a3d2b;
        }
        .leaflet-popup-content p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        .leaflet-popup-tip {
            background: #fdf5e6;
        }
        .popup-button {
            background-color: #6a0dad;
            color: #fff;
            padding: 8px 12px;
            border: 1px solid #40006b;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Merriweather', serif;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            display: block;
            width: calc(100% - 10px);
            margin: 10px 5px 5px 5px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .popup-button:hover {
            background-color: #800080;
            border-color: #500050;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            padding-top: 20px;
        }
        .modal-content {
            background-color: #f5e8c8;
            margin: 5% auto;
            padding: 25px;
            border: 5px solid #8c0000;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 0 25px rgba(0,0,0,0.8);
            position: relative;
            font-family: 'Merriweather', serif;
            color: #4a3b31;
        }
        .modal-content h2, .modal-content h3 {
             font-family: 'IM Fell English SC', serif;
             color: #5a3d2b;
        }
        .close-button {
            color: #5a3d2b;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 35px;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: #8c0000;
            text-decoration: none;
            cursor: pointer;
        }
        #modalCharacterCard {
            width: 100%;
            max-width: 250px;
            height: auto;
            object-fit: contain;
            margin-top: 15px;
            margin-bottom: 15px;
            border: 3px solid #8c0000;
            border-radius: 8px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        #modalImage {
            width: 100%;
            max-width: 400px;
            object-fit: contain;
            margin-top: 15px;
            border: 2px solid #8B4513;
            border-radius: 5px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .image-toggle-buttons button {
            background-color: #8B4513;
            color: white;
            padding: 10px 15px;
            margin: 10px 5px 0 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Merriweather', serif;
            transition: background-color 0.3s ease;
        }
        .image-toggle-buttons button:hover {
            background-color: #A0522D;
        }
        .intro-text {
            background-color: rgba(245, 232, 200, 0.9);
            padding: 20px;
            margin: 30px auto;
            border-radius: 8px;
            border: 3px dashed #8c0000;
            text-align: justify;
            color: #4a3b31;
            max-width: 900px;
            position: relative;
            z-index: 101;
        }
         .intro-text h2 {
            font-family: 'IM Fell English SC', serif;
            color: #5a3d2b;
         }

        .custom-marker-icon {
            background-color: #8B4513;
            border: 2px solid #D2B48C;
            border-radius: 50%;
            width: 20px !important;
            height: 20px !important;
            text-align: center;
            line-height: 16px;
            color: white;
            font-weight: bold;
            font-size: 10px;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .image-animation-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 2 / 3;
            margin-top: 15px;
            border: 2px solid #8B4513;
            border-radius: 5px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            overflow: hidden;
        }
        .animated-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        .animated-image.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <img src="https://i.postimg.cc/YCfDn7rz/M1895withlightning.png" alt="Mission 1895 Lockport Logo" id="floating-logo">

    <div id="map"></div>

    <div class="intro-text mt-6 mb-6 hidden-on-load">
        <h2 class="text-3xl mb-3 title-font">A Message from The Sentinel...</h2>
        <p>In the early 1830’s, dreamy eyed settlers from the east had arrived on the unbroken prairie of what would soon be known as Lockport. Because of a forty-foot drop in elevation along the Des Plaines River, men with vision saw that they could harness nature and supply hydro-electric power for all their needs. Terrain thus fated Lockport to be the headquarters of the great I&M Canal – an inland waterway linking New York to New Orleans... But by 1895, the once promising and hopeful city of Lockport had fallen into darkness... The evil that undermines men’s desires to build towers to heaven by their own hand had beginnings much further back...</p>
        <p class="mt-2">Use this Chrono-Map to navigate the streets of 1895 Lockport, uncover the secrets of its denizens, and aid in a mission of utmost importance!</p>
    </div>

    <div id="detailsModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal()">×</span>
        <h2 id="modalTitle" class="text-3xl mb-3"></h2>
        <p><strong>Address:</strong> <a id="modalAddressLink" href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 visited:text-purple-600"><span id="modalAddress"></span></a></p>
        <p><strong>Status:</strong> <span id="modalOpenStatus"></span></p>
        <p><strong>Today's Hours:</strong> <span id="modalTodaysHours"></span></p>

        <h3 class="text-xl mt-4 mb-2">Chronovisor Report:</h3>
        <div id="modalDescription" class="text-sm leading-relaxed max-h-60 overflow-y-auto pr-2"></div>
         <div class="image-toggle mt-4 text-center">
             <img id="modalSteampunkImage" src="" alt="1895 Steampunk View" style="display: none; width: 100%; max-width: 400px; object-fit: contain; margin-top: 15px; border: 2px solid #8B4513; border-radius: 5px; display: block; margin-left: auto; margin-right: auto;">
             </div>
      </div>
    </div>
    
    <div class="map-controls"> 
        <label for="opacitySlider">Fantasy Map Opacity:</label>
        <input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="1.0">
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
     <script src="locations.js"></script>

    <script>
        // --- MAP INITIALIZATION ---
        // Define the boundaries for the map to keep it focused on the fantasy area
        const corner1 = L.latLng(41.592, -88.054);
        const corner2 = L.latLng(41.560, -88.072);
        const bounds = L.latLngBounds(corner1, corner2);

        const map = L.map('map', {
            zoomControl: false, // Disable zoom control to keep the view clean
            minZoom: 17, // Prevent zooming out too far
            maxBounds: bounds, // Restrict panning to the fantasy map area
            maxBoundsViscosity: 1.0 // Makes the bounds completely solid
        }).setView([41.576, -88.063], 19); // Centered on fantasy map at maximum zoom


        // Satellite Base Layer (can be removed if you ONLY want the fantasy map)
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        }); //.addTo(map); // Initially commented out to only show fantasy map

        // Fantasy Map Overlay from MapWarper
        const fantasyMapUrl = 'https://mapwarper.net/maps/tile/91451/{z}/{x}/{y}.png';
        const fantasyMapLayer = L.tileLayer(fantasyMapUrl, {
            attribution: 'Fantasy Map Overlay © <a href="https://mapwarper.net/maps/91451" target="_blank">MapWarper</a>',
            opacity: 1.0,
            minZoom: 13,
            maxZoom: 19,
            tms: false
        }).addTo(map);

        fantasyMapLayer.on('tileerror', function(event) {
            console.error('Fantasy map tile failed to load:', event.tile, event.url);
        });

        // Opacity Slider Event Listener
        const opacitySlider = document.getElementById('opacitySlider');
        opacitySlider.addEventListener('input', function (e) {
            const newOpacity = parseFloat(e.target.value);
            fantasyMapLayer.setOpacity(newOpacity);

            // Optional: Show satellite layer if fantasy map is partially transparent
            if (newOpacity < 1.0 && !map.hasLayer(satelliteLayer)) {
                map.addLayer(satelliteLayer);
                satelliteLayer.bringToBack();
            } else if (newOpacity >= 1.0 && map.hasLayer(satelliteLayer)) {
                map.removeLayer(satelliteLayer);
            }
        });


        // --- MODAL GLOBALS ---
        const modal = document.getElementById('detailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalAddress = document.getElementById('modalAddress');
        const modalAddressLink = document.getElementById('modalAddressLink');
        const modalOpenStatus = document.getElementById('modalOpenStatus');
        const modalTodaysHours = document.getElementById('modalTodaysHours');
        const modalDescription = document.getElementById('modalDescription');
        const modalSteampunkImage = document.getElementById('modalSteampunkImage');

        let currentModalLocation = null;


        // --- ADD MARKERS TO MAP ---
        locationsData.forEach(location => {
            const customIcon = L.divIcon({
                className: 'custom-marker-icon',
                html: `<span>${location.id}</span>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });

            const marker = L.marker([location.lat, location.lon], { icon: customIcon }).addTo(map);
            const popupContent = `
                <h3 class="title-font">${location.locationName}</h3>
                <p><strong>Address:</strong> ${location.address}</p>
                <p><strong>Card Name:</strong> ${location.characterName}: Card #${location.id}</p>
                <button class="popup-button" onclick="showDetails(${location.id})">View Details</button>
            `;
            marker.bindPopup(popupContent);
        });

        // --- VALIDATION FUNCTION FOR IMAGE URLS ---
        function isValidImageUrl(url) {
            return url && typeof url === 'string' && !url.includes('placehold.co') && url.startsWith('http');
        }

       // --- BUSINESS HOURS FUNCTIONS ---
        function getOpeningHours(hoursString) {
            const hours = {};
            if (!hoursString || hoursString.toLowerCase() === 'hours not listed' || hoursString.toLowerCase() === 'hours not available') {
                return null;
            }
            // Regex to handle various formats like "Mon-Fri", "Mon, Tue", etc.
            const dayRanges = hoursString.split(/, (?=[A-Z][a-z]{2}:)/);
            const dayMap = { 'Mon': 0, 'Tue': 1, 'Wed': 2, 'Thu': 3, 'Fri': 4, 'Sat': 5, 'Sun': 6 };
            const dayAbbrs = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];


            dayRanges.forEach(rangeInfo => {
                const [daysPart, timesPart] = rangeInfo.split(/: /);
                const [startTimeStr, endTimeStr] = timesPart.split(' - ');

                if (daysPart.includes('-')) { // Handles ranges like "Mon-Fri"
                    const [startDay, endDay] = daysPart.split('-');
                    let startIndex = dayAbbrs.indexOf(startDay);
                    let endIndex = dayAbbrs.indexOf(endDay);
                    for (let i = startIndex; i <= endIndex; i++) {
                         hours[dayAbbrs[i]] = { start: startTimeStr, end: endTimeStr };
                    }
                } else { // Handles single days like "Sat"
                    hours[daysPart] = { start: startTimeStr, end: endTimeStr };
                }
            });
            return hours;
        }


        function checkIfOpen(openingHours) {
            if (!openingHours) {
                return { isOpen: "N/A", todaysHours: "Not available" };
            }

            const now = new Date();
             const dayOfWeek = now.toLocaleString('en-US', { weekday: 'short' }); // Mon, Tue, etc.

            const todaysHoursData = openingHours[dayOfWeek];

            if (!todaysHoursData) {
                return { isOpen: "Closed", todaysHours: "Closed Today" };
            }

             const parseTime = (timeStr) => {
                if (!timeStr) return null;
                const normalizedTime = timeStr.toLowerCase().replace(/:\s/g, ':');
                let [time, modifier] = normalizedTime.split(/(am|pm)/);
                if (!modifier) { // Handle "Noon" case
                    if(time.trim() === 'noon') return new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0);
                    return null; // or handle other non-standard times
                }

                let [hours, minutes] = time.split(':');
                hours = parseInt(hours, 10);
                minutes = minutes ? parseInt(minutes, 10) : 0;

                if (modifier === 'pm' && hours < 12) hours += 12;
                if (modifier === 'am' && hours === 12) hours = 0; // Midnight case

                const date = new Date(now.getTime());
                date.setHours(hours, minutes, 0, 0);
                return date;
            };

            const startTime = parseTime(todaysHoursData.start);
            const endTime = parseTime(todaysHoursData.end);

            if (!startTime || !endTime) {
                 return { isOpen: "N/A", todaysHours: "Invalid time format" };
            }

            const isOpen = now >= startTime && now <= endTime;
            const statusString = isOpen ? "Open Now" : "Closed";

            return { isOpen: statusString, todaysHours: `${todaysHoursData.start} - ${todaysHoursData.end}` };
        }


        // --- MODAL FUNCTIONS ---
        function showDetails(locationId) {
            currentModalLocation = locationsData.find(loc => loc.id === locationId);
            if (!currentModalLocation) return;

            // Set basic info
            modalTitle.textContent = currentModalLocation.locationName;
            modalAddress.textContent = currentModalLocation.address;
            modalAddressLink.href = `https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(currentModalLocation.address)}`;
            modalDescription.innerHTML = currentModalLocation.description.replace(/\\n/g, '<br>');


            // Check and display open status
            const openingHours = getOpeningHours(currentModalLocation.hours);
            const openStatus = checkIfOpen(openingHours);
            modalOpenStatus.textContent = openStatus.isOpen;
            modalTodaysHours.textContent = openStatus.todaysHours;


            // Handle Steampunk Image Display
            let steampunkImageSource = currentModalLocation.image1895SteampunkUrl || currentModalLocation.imageSteampunkUrl;
            if (isValidImageUrl(steampunkImageSource)) {
                modalSteampunkImage.src = steampunkImageSource;
                modalSteampunkImage.alt = `1895 Steampunk view of ${currentModalLocation.locationName}`;
                modalSteampunkImage.style.display = 'block';
                modalSteampunkImage.onerror = function() { this.style.display = 'none'; };
            } else {
                modalSteampunkImage.style.display = 'none';
            }

            // Display the modal
            modal.style.display = "block";
        }


        function closeModal() {
            modal.style.display = "none";
            currentModalLocation = null;
            // Clear content to prevent flash of old content
            modalTitle.textContent = '';
            modalAddress.textContent = '';
            modalAddressLink.href = '#';
            modalOpenStatus.textContent = '';
            modalTodaysHours.textContent = '';
            modalDescription.innerHTML = '';
            modalSteampunkImage.src = '';
            modalSteampunkImage.style.display = 'none';

        }


        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                closeModal();
            }
        });

    </script>
</body>
</html>