<script>
        // --- MAP INITIALIZATION ---
        // Define the boundaries for the map to keep it focused on the fantasy area
        const corner1 = L.latLng(41.592, -88.054);
        const corner2 = L.latLng(41.560, -88.072);
        const bounds = L.latLngBounds(corner1, corner2);

        const map = L.map('map', {
            zoomControl: false, // Disable zoom control to keep the view clean
            attributionControl: false, // ADD THIS LINE to remove the attribution
            minZoom: 17, // Prevent zooming out too far
            maxBounds: bounds, // Restrict panning to the fantasy map area
            maxBoundsViscosity: 1.0 // Makes the bounds completely solid
        }).setView([41.589631, -88.057953], 19); // Centered on the intersection of 9th and State St


        // Satellite Base Layer (can be removed if you ONLY want the fantasy map)
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            // The attribution for this layer will not be displayed if attributionControl is false on the map
            maxZoom: 19
        }).addTo(map).bringToBack();

        // Fantasy Map Overlay from MapWarper
        const fantasyMapUrl = 'https://mapwarper.net/maps/tile/93417/{z}/{x}/{y}.png'; // Updated URL
        const fantasyMapLayer = L.tileLayer(fantasyMapUrl, {
             // The attribution for this layer will not be displayed if attributionControl is false on the map
            opacity: 0.99,
            minZoom: 13,
            maxZoom: 19,
            tms: false
        }).addTo(map);

        fantasyMapLayer.on('tileerror', function(event) {
            console.error('Fantasy map tile failed to load:', event.tile, event.url);
        });

        // Opacity Slider Event Listener
        const opacitySlider = document.getElementById('opacitySlider');
        opacitySlider.addEventListener('input', function (e) {
            const newOpacity = parseFloat(e.target.value);
            fantasyMapLayer.setOpacity(newOpacity);
        });


        // --- MODAL GLOBALS ---
        const modal = document.getElementById('detailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalAddress = document.getElementById('modalAddress');
        const modalAddressLink = document.getElementById('modalAddressLink');
        const modalOpenStatus = document.getElementById('modalOpenStatus');
        const modalTodaysHours = document.getElementById('modalTodaysHours');
        const modalDescription = document.getElementById('modalDescription');
        const modalSteampunkImage = document.getElementById('modalSteampunkImage');

        let currentModalLocation = null;

        // --- NEW THUMBNAIL URLS ---
        const newThumbnailUrls = [
            "https://i.postimg.cc/c47rxyvm/01-Card-Evil-Buried.jpg",          // ID 1
            "https://i.postimg.cc/kMb2Ht9L/02-Card-Fate-Unleased.jpg",        // ID 2
            "https://i.postimg.cc/QdXVV45r/03-Card-Milo-Perkins.jpg",         // ID 3
            "https://i.postimg.cc/htpvmLbQ/04-Card-Hiram-Norton.jpg",         // ID 4
            "https://i.postimg.cc/CK51sRmP/05-Card-Camp-Dellwood.jpg",        // ID 5
            "https://i.postimg.cc/rpHpnqH8/06-Card-John-Sears.jpg",           // ID 6
            "https://i.postimg.cc/4dhxjrCp/07-Card-Jim-Stephenson.jpg",       // ID 7
            "https://i.postimg.cc/tJQ4b2yw/08-Card-Lorna-Arrival.jpg",        // ID 8
            "https://i.postimg.cc/GtFhmGm2/09-Card-William-Gooding.jpg",      // ID 9
            "https://i.postimg.cc/zXNGPtxR/10-Card-Another-Calling.jpg",      // ID 10
            "https://i.postimg.cc/nVBL2bGJ/11-Card-Charles-Boyer.jpg",        // ID 11
            "https://i.postimg.cc/QxqdLQzY/12-Card-Ichabod-Codding.jpg",       // ID 12
            "https://i.postimg.cc/7ZYYqC8H/13-Card-George-Gaylord.jpg",       // ID 13
            "https://i.postimg.cc/XYHNqV4w/14-Card-Investigation.jpg",        // ID 14
            "https://i.postimg.cc/bvZy2Kw4/15-Card-John-Lamb.jpg",            // ID 15
            "https://i.postimg.cc/JhS13Py0/16-Card-Armstead-Runyon.jpg",       // ID 16
            "https://i.postimg.cc/LXfmxLfT/17-Change-of-Plans.jpg",           // ID 17
            "https://i.postimg.cc/Znx4Smwv/18-Card-Dorothy-Dow.jpg",          // ID 18
            "https://i.postimg.cc/prHR4rJt/19-Card-Francis-Tully.jpg",        // ID 19
            "https://i.postimg.cc/HWwp50TW/20-Card-Ernest-Caneva.jpg",        // ID 20
            "https://i.postimg.cc/28CCxq5Q/21-Card-John-Lane.jpg",            // ID 21
            "https://i.postimg.cc/15Ms79gL/22-Card-Urgent-Business.jpg",      // ID 22
            "https://i.postimg.cc/nhzZ66BM/23-Card-Hiram-Lawrence.jpg",       // ID 23
            "https://i.postimg.cc/YCskkbzR/24-Card-Robert-Burcenski.jpg",     // ID 24
            "https://i.postimg.cc/3w0hwmLT/25-Card-Styx-Mc-Donald.jpg",       // ID 25
            "https://i.postimg.cc/V6y80vTb/26-Card-Gilbert-Bengston.jpg",     // ID 26
            "https://i.postimg.cc/fLxhcZnq/27-Card-Marie-Cook.jpg",           // ID 27
            "https://i.postimg.cc/T1fvQSTd/28-Card-HH-Carter.jpg",            // ID 28
            "https://i.postimg.cc/ZnHtQcqr/29-Card-Gladys-Fox.jpg",           // ID 29
            "https://i.postimg.cc/3rFTWKZd/30-Card-Horace-Singer.jpg",        // ID 30
            "https://i.postimg.cc/hP4qdHCM/31-Card-Restrained.jpg",           // ID 31
            "https://i.postimg.cc/Qx6Zk0wD/32-Card-Haley-Augello.jpg",        // ID 32
            "https://i.postimg.cc/y8k4f0CZ/33-Card-Robert-Carr.jpg",          // ID 33
            "https://i.postimg.cc/wjZKn39b/34-Card-Minora-Paxson.jpg",        // ID 34
            "https://i.postimg.cc/nLm8xZzV/35-Card-Labor-and-Innovation.jpg", // ID 35
            "https://i.postimg.cc/bJf7NMDx/36-Card-Dorothy-Worst.jpg",        // ID 36
            "https://i.postimg.cc/ydhwJPcw/37-Card-Transference.jpg",         // ID 37
            "https://i.postimg.cc/90Wsy7Bz/38-Card-Press-Gang.jpg",           // ID 38
            "https://i.postimg.cc/0jcFnytn/39-Card-Common-Destiny.jpg",       // ID 39
            "https://i.postimg.cc/KcN6x0ZT/40-Card-Jax-and-Lorna.jpg"         // ID 40
        ];

        // --- ADD MARKERS TO MAP ---
        locationsData.forEach(location => {
            const thumbnailUrl = newThumbnailUrls[location.id - 1]; 

            const cardIcon = L.icon({
                iconUrl: thumbnailUrl,
                iconSize: [40, 60], 
                iconAnchor: [20, 60], 
                popupAnchor: [0, -60],
                className: 'card-thumbnail-icon' // Added custom class for hover effects
            });

            const marker = L.marker([location.lat, location.lon], { icon: cardIcon }).addTo(map);
            
            const popupContent = `
                <h3 class="title-font">${location.locationName}</h3>
                <p><strong>Address:</strong> ${location.address}</p>
                <p><strong>Card Name:</strong> ${location.characterName}: Card #${location.id}</p>
                <button class="popup-button" onclick="showDetails(${location.id})">View Details</button>
            `;
            marker.bindPopup(popupContent);
        });

        // --- VALIDATION FUNCTION FOR IMAGE URLS ---
        function isValidImageUrl(url) {
            return url && typeof url === 'string' && !url.includes('placehold.co') && url.startsWith('http');
        }

       // --- BUSINESS HOURS FUNCTIONS ---
        function getOpeningHours(hoursString) {
            const hours = {};
            if (!hoursString || hoursString.toLowerCase() === 'hours not listed' || hoursString.toLowerCase() === 'hours not available') {
                return null;
            }
            const dayRanges = hoursString.split(/, (?=[A-Z][a-z]{2}:)/);
            const dayMap = { 'Mon': 0, 'Tue': 1, 'Wed': 2, 'Thu': 3, 'Fri': 4, 'Sat': 5, 'Sun': 6 };
            const dayAbbrs = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];


            dayRanges.forEach(rangeInfo => {
                const [daysPart, timesPart] = rangeInfo.split(/: /);
                if (!timesPart) return;
                const [startTimeStr, endTimeStr] = timesPart.split(' - ');

                if (daysPart.includes('-')) {
                    const [startDay, endDay] = daysPart.split('-');
                    let startIndex = dayAbbrs.indexOf(startDay);
                    let endIndex = dayAbbrs.indexOf(endDay);
                    for (let i = startIndex; i <= endIndex; i++) {
                         hours[dayAbbrs[i]] = { start: startTimeStr, end: endTimeStr };
                    }
                } else {
                    hours[daysPart] = { start: startTimeStr, end: endTimeStr };
                }
            });
            return hours;
        }


        function checkIfOpen(openingHours) {
            if (!openingHours) {
                return { isOpen: "N/A", todaysHours: "Not available" };
            }

            const now = new Date();
             const dayOfWeek = now.toLocaleString('en-US', { weekday: 'short' });

            const todaysHoursData = openingHours[dayOfWeek];

            if (!todaysHoursData) {
                return { isOpen: "Closed", todaysHours: "Closed Today" };
            }

             const parseTime = (timeStr) => {
                if (!timeStr) return null;
                const normalizedTime = timeStr.toLowerCase().replace(/:\s/g, ':');
                let [time, modifier] = normalizedTime.split(/(am|pm)/);
                
                if(time.trim() === 'noon') return new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0);

                if (!modifier) { 
                    modifier = 'pm'; 
                }


                let [hours, minutes] = time.split(':');
                hours = parseInt(hours, 10);
                minutes = minutes ? parseInt(minutes, 10) : 0;

                if (modifier === 'pm' && hours < 12) hours += 12;
                if (modifier === 'am' && hours === 12) hours = 0;

                const date = new Date(now.getTime());
                date.setHours(hours, minutes, 0, 0);
                return date;
            };

            const startTime = parseTime(todaysHoursData.start);
            const endTime = parseTime(todaysHoursData.end);
            
            if (endTime < startTime) {
                endTime.setDate(endTime.getDate() + 1);
                if (now < startTime) {
                    now.setDate(now.getDate() + 1);
By making this change, the box containing the "Leaflet | Tiles Â© Esri..." text will no longer be displayed on the map.
                }
            }


            if (!startTime || !endTime) {
                 return { isOpen: "N/A", todaysHours: "Invalid time format" };
            }

            const isOpen = now >= startTime && now <= endTime;
            const statusString = isOpen ? "Open Now" : "Closed";

            return { isOpen: statusString, todaysHours: `${todaysHoursData.start} - ${todaysHoursData.end}` };
        }


        // --- MODAL FUNCTIONS ---
        function showDetails(locationId) {
            currentModalLocation = locationsData.find(loc => loc.id === locationId);
            if (!currentModalLocation) return;

            modalTitle.textContent = currentModalLocation.locationName;
            modalAddress.textContent = currentModalLocation.address;
            modalAddressLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currentModalLocation.address)}`;
            
            const openingHours = getOpeningHours(currentModalLocation.hours);
            const openStatus = checkIfOpen(openingHours);
            modalOpenStatus.textContent = openStatus.isOpen;
            modalTodaysHours.textContent = openStatus.todaysHours;

            let steampunkImageSource = currentModalLocation.image1895SteampunkUrl || currentModalLocation.imageSteampunkUrl;
            if (isValidImageUrl(steampunkImageSource)) {
                modalSteampunkImage.src = steampunkImageSource;
                modalSteampunkImage.alt = `1895 Steampunk view of ${currentModalLocation.locationName}`;
                modalSteampunkImage.style.display = 'block';
                modalSteampunkImage.onerror = function() { this.style.display = 'none'; };
            } else {
                modalSteampunkImage.style.display = 'none';
            }

            modalDescription.innerHTML = currentModalLocation.description.replace(/\\n/g, '<br>');
            modal.style.display = "block";
        }


        function closeModal() {
            modal.style.display = "none";
            currentModalLocation = null;
            modalTitle.textContent = '';
            modalAddress.textContent = '';
            modalAddressLink.href = '#';
            modalOpenStatus.textContent = '';
            modalTodaysHours.textContent = '';
            modalDescription.innerHTML = '';
            modalSteampunkImage.src = '';
            modalSteampunkImage.style.display = 'none';

        }


        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                closeModal();
            }
        });

    </script>